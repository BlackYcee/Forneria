{% extends "pos/basepos.html" %}
{% load static currency %}

{% block content  %}
<!-- Estilos específicos para POS (cache-bust: v3) -->
<link rel="stylesheet" href="{% static 'css/pos.css' %}?v=3">
<div class="center">
    <header class="pos-header" style="margin-bottom:0.6rem;">
        <h1 style="font-size: 1.8rem; color:#222; margin:0 0 8px 0;">Punto de venta</h1>

        <!-- Opciones de búsqueda y filtro -->
        <div class="containeropciones" style="display:flex; gap:10px; align-items:center;">
            <form action="" method="GET" style="display:flex; gap:8px; align-items:center; flex:1;">
                <input name="buscar" type="text" placeholder="Nombre o Código" style="padding:8px 10px; border-radius:8px; border:1px solid rgba(0,0,0,0.08); width:320px;" value="{{ request.GET.buscar|default:'' }}">
                <button type="submit" class="button1" style="padding:8px 12px;">Buscar</button>
                <button type="button" class="btn-secondary" onclick="alert('Función de escaneo no implementada aún')">Escanear</button>
                <div style="margin-left:auto;">
                    <select name="categorias" id="categorias" onchange="this.form.submit()" style="padding:8px 10px; border-radius:8px; border:1px solid rgba(0,0,0,0.06);">
                        <option value="">Todas las categorías</option>
                        {% for categoria in categorias %}
                            <option value="{{ categoria.id }}" {% if request.GET.categorias == categoria.id|stringformat:"s" %}selected{% endif %}>{{ categoria.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
            </form>
        </div>
    </header>

    <!-- Tarjetas de productos -->
    <div class="containercartas">
        {% for producto in page_obj %}
            <div class="card" data-id="{{ producto.id }}" data-nombre="{{ producto.nombre }}" data-precio="{{ producto.precio_venta|floatformat:0 }}">
                <div class="w3-container w3-center">
                    <h2>{{ producto.nombre }}</h2>
                    <p style="font-size:0.85rem; color:#666;">Código de barra: {{ producto.codigo_barra|default:'None' }}</p>
                    <p style="font-size:0.9rem;">Stock disponible: <strong>{{ producto.stock_total }}</strong></p>
                    <p style="margin-top:6px;">Precio: <span class="precio">{{ producto.precio_venta|floatformat:0|clp }}</span></p>
                    <div class="card-actions">
                        <button class="button1 add-to-cart" data-id="{{ producto.id }}" data-nombre="{{ producto.nombre }}" data-precio="{{ producto.precio_venta|floatformat:0 }}">Agregar al carrito</button>
                        <button class="btn-secondary view-detail" data-id="{{ producto.id }}">Ver detalle</button>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>

    <!-- Controles de paginación -->
    <div class="pagination">
        <span class="step-links">
            {% if page_obj.has_previous %}
                <a href="?page=1{% if request.GET.buscar %}&buscar={{ request.GET.buscar }}{% endif %}{% if request.GET.categorias %}&categorias={{ request.GET.categorias }}{% endif %}">Primera</a>
                <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.buscar %}&buscar={{ request.GET.buscar }}{% endif %}{% if request.GET.categorias %}&categorias={{ request.GET.categorias }}{% endif %}">Anterior</a>
            {% endif %}

            <span class="current">
                Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
            </span>

            {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}{% if request.GET.buscar %}&buscar={{ request.GET.buscar }}{% endif %}{% if request.GET.categorias %}&categorias={{ request.GET.categorias }}{% endif %}">Siguiente</a>
                <a href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.buscar %}&buscar={{ request.GET.buscar }}{% endif %}{% if request.GET.categorias %}&categorias={{ request.GET.categorias }}{% endif %}">Última</a>
            {% endif %}
        </span>
    </div>
</div>

<!-- Sección lateral derecha -->
<div class="side">
    <div class="containerusuario">
        <h5>Usuario:</h5>
    </div>
    
    <div class="containercarrito">
        <h3>Carrito de compras</h3>
        <div id="cart">
            <ul class="list-group" id="cart-items">
                <!-- items dinámicos -->
            </ul>
            <div class="cart-footer">
                <p>Total: $<span id="cart-total">0.00</span></p>
                <button id="checkout-btn" class="button1">Finalizar compra</button>
                <button id="clear-cart" class="button1">Vaciar</button>
            </div>
        </div>
    </div>
</div>
<!-- Modal detalle producto -->
<div id="productModal" class="modal" style="display:none;">
    <div class="modal-content">
        <span id="modal-close" class="modal-close">&times;</span>
        <h2 id="modal-nombre"></h2>
        <p id="modal-descripcion"></p>
        <p>Precio: $<span id="modal-precio"></span></p>
        <p>Stock: <span id="modal-stock"></span></p>
    </div>
</div>

<!-- Modal carrito / checkout -->
<div id="cartModal" class="modal" style="display:none;">
    <div class="modal-content">
        <span id="cart-modal-close" class="modal-close">&times;</span>
        <h2>Resumen de la venta</h2>
        <div class="sale-meta">Fecha y hora:<strong id="cart-datetime"> -</strong></div>
        <div id="cart-modal-items" class="cart-modal-items">
            <!-- items dinámicos -->
        </div>
        <hr>
        <p>Subtotal: <strong id="cart-subtotal">$0</strong></p>
        <p>IVA (19%): <strong id="cart-iva">$0</strong></p>
        <p>Total: <strong id="cart-total-modal">$0</strong></p>

        <label for="monto-pagado">Monto pagado:</label>
        <input id="monto-pagado" type="number" step="1" min="0" />
        <p>Vuelto: <strong id="cart-change">$0</strong></p>

        <div style="margin-top:0.6rem;">
            <label for="metodo-pago">Método de pago:</label>
            <select id="metodo-pago" style="margin-left:8px; padding:6px 8px; border-radius:6px;">
                <option value="efectivo">Efectivo</option>
                <option value="tarjeta_debito">Tarjeta débito</option>
                <option value="tarjeta_credito">Tarjeta crédito</option>
            </select>
        </div>

        <div style="margin-top:1rem; display:flex; gap:0.6rem; justify-content:flex-end;">
            <button id="cancel-sale" class="btn-outline">Cancelar</button>
            <button id="confirm-sale" class="btn-primary">Confirmar venta (simulación)</button>
        </div>
    </div>
</div>

<script src="{% static 'js/pos.js' %}?v=3"></script>
{% endblock %}
