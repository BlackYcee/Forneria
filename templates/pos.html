{% extends "basepos.html" %}
{% load static currency_extras %}

{% block content  %}
<!-- Estilos específicos para POS (cache-bust: v2) -->
<link rel="stylesheet" href="{% static 'css/pos.css' %}?v=2">
<div class="center">
    <h1 style="font-size: 2rem; color:#fff; margin-top: 0;">Punto de venta</h1>

    <!-- Opciones de búsqueda y filtro -->
    <div class="containeropciones">
        <div class="search">
            <form action="" method="GET">
                <input type="text" placeholder="Nombre o Código" name="buscar">
                <button type="submit" class="btn-search">
                    <i class="fas fa-search"></i> Buscar
                </button>
                <button type="button" class="btn-scan">
                    <i class="fas fa-barcode"></i> Escanear
                </button>
            </form>
        </div>

        <!-- Filtro dinámico de categorías -->
        <div class="filter">
            <select name="categorias" id="categorias" onchange="this.form.submit()">
                <option value="" disabled selected>Seleccionar categoría</option>
                {% for categoria in categorias %}
                    <option value="{{ categoria.id }}">{{ categoria.nombre }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <!-- Tarjetas de productos -->
    <div class="containercartas">
        {% for producto in page_obj %}
            <div class="card" data-id="{{ producto.id }}" data-nombre="{{ producto.nombre }}" data-precio="{{ producto.precio|floatformat:0 }}">
                <div class="w3-container w3-center">
                    <h2>{{ producto.nombre }}</h2>
                    <p>Código de barra: {{ producto.codigo_barra }}</p>
                    <p>Stock disponible: <strong>{{ producto.stock_total }}</strong></p>
                        <p>Precio: <strong>{{ producto.precio|floatformat:0|clp }}</strong></p>
                    <div class="card-actions">
                            <button class="button1 add-to-cart" data-id="{{ producto.id }}" data-nombre="{{ producto.nombre }}" data-precio="{{ producto.precio|floatformat:0 }}">Agregar al carrito</button>
                        <button class="button1 view-detail" data-id="{{ producto.id }}">Ver detalle</button>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>

    <!-- Controles de paginación -->
    <div class="pagination">
        <span class="step-links">
            {% if page_obj.has_previous %}
                <a href="?page=1{% if request.GET.buscar %}&buscar={{ request.GET.buscar }}{% endif %}{% if request.GET.categorias %}&categorias={{ request.GET.categorias }}{% endif %}">Primera</a>
                <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.buscar %}&buscar={{ request.GET.buscar }}{% endif %}{% if request.GET.categorias %}&categorias={{ request.GET.categorias }}{% endif %}">Anterior</a>
            {% endif %}

            <span class="current">
                Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
            </span>

            {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}{% if request.GET.buscar %}&buscar={{ request.GET.buscar }}{% endif %}{% if request.GET.categorias %}&categorias={{ request.GET.categorias }}{% endif %}">Siguiente</a>
                <a href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.buscar %}&buscar={{ request.GET.buscar }}{% endif %}{% if request.GET.categorias %}&categorias={{ request.GET.categorias }}{% endif %}">Última</a>
            {% endif %}
        </span>
    </div>
</div>

<!-- Sección lateral derecha -->
<div class="side">
    <div class="containerusuario">
        <h5>Usuario:</h5>
    </div>
    
    <div class="containercarrito">
        <h3>Carrito de compras</h3>
        <div id="cart">
            <ul class="list-group" id="cart-items">
                <!-- items dinámicos -->
            </ul>
            <div class="cart-footer">
                <p>Total: $<span id="cart-total">0.00</span></p>
                <button id="checkout-btn" class="button1">Finalizar compra</button>
                <button id="clear-cart" class="button1">Vaciar</button>
            </div>
        </div>
    </div>
</div>
<!-- Modal detalle producto -->
<div id="productModal" class="modal" style="display:none;">
    <div class="modal-content">
        <span id="modal-close" class="modal-close">&times;</span>
        <h2 id="modal-nombre"></h2>
        <p id="modal-descripcion"></p>
        <p>Precio: $<span id="modal-precio"></span></p>
        <p>Stock: <span id="modal-stock"></span></p>
    </div>
</div>

<!-- Modal carrito / checkout -->
<div id="cartModal" class="modal" style="display:none;">
    <div class="modal-content">
        <span id="cart-modal-close" class="modal-close">&times;</span>
        <h2>Resumen de la venta</h2>
        <div id="cart-modal-items">
            <!-- items dinámicos -->
        </div>
        <hr>
        <p>Subtotal: <strong id="cart-subtotal">$0</strong></p>
        <p>IVA (19%): <strong id="cart-iva">$0</strong></p>
        <p>Total: <strong id="cart-total-modal">$0</strong></p>

        <label for="monto-pagado">Monto pagado:</label>
        <input id="monto-pagado" type="number" step="1" min="0" />
        <p>Vuelto: <strong id="cart-change">$0</strong></p>

        <div style="margin-top:1rem;">
            <button id="confirm-sale" class="button1">Confirmar venta (simulación)</button>
            <button id="cancel-sale" class="button1">Cancelar</button>
        </div>
    </div>
</div>

<script src="{% static 'js/pos.js' %}"></script>
{% endblock %}
