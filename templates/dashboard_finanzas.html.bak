{% extends 'basepos.html' %}
{% load static %}
{% load analytics_extras %}

{% block content %}
<div class="py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2 mb-0">üìä Dashboard Financiero</h1>
        <div class="text-muted">
            <small>√öltima actualizaci√≥n: <span id="ultimo-update">{{ fecha_actual }}</span></small>
        </div>
    </div>

    <!-- KPIs del D√≠a -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-primary">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Ventas Hoy</h6>
                    <h3 class="card-title mb-1">${{ kpis.hoy.total|floatformat:0 }}</h3>
                    <small class="text-muted">{{ kpis.hoy.cantidad }} transacciones</small>
                    {% if kpis.variacion_pct > 0 %}
                        <p class="mb-0 mt-2"><span class="badge bg-success">‚Üë {{ kpis.variacion_pct|floatformat:1 }}%</span></p>
                    {% elif kpis.variacion_pct < 0 %}
                        <p class="mb-0 mt-2"><span class="badge bg-danger">‚Üì {{ kpis.variacion_pct|floatformat:1 }}%</span></p>
                    {% else %}
                        <p class="mb-0 mt-2"><span class="badge bg-secondary">{{ kpis.variacion_pct|floatformat:1 }}%</span></p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-success">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Ventas √öltimos 30 D√≠as</h6>
                    <h3 class="card-title mb-1">${{ resumen.total_ventas|floatformat:0 }}</h3>
                    <small class="text-muted">{{ resumen.cantidad_transacciones }} ventas</small>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-info">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Ticket Promedio</h6>
                    <h3 class="card-title mb-1">${{ resumen.ticket_promedio|floatformat:0 }}</h3>
                    <small class="text-muted">Por transacci√≥n</small>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-warning">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Descuentos Totales</h6>
                    <h3 class="card-title mb-1">${{ resumen.total_descuentos|floatformat:0 }}</h3>
                    <small class="text-muted">√öltimos 30 d√≠as</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Desglose Financiero -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">üí∞ Desglose Financiero (30 d√≠as)</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tbody>
                            <tr>
                                <td>Total sin IVA:</td>
                                <td class="text-end"><strong>${{ resumen.total_sin_iva|floatformat:2 }}</strong></td>
                            </tr>
                            <tr>
                                <td>IVA (19%):</td>
                                <td class="text-end"><strong>${{ resumen.total_iva|floatformat:2 }}</strong></td>
                            </tr>
                            <tr class="table-active">
                                <td><strong>Total con IVA:</strong></td>
                                <td class="text-end"><strong class="text-success">${{ resumen.total_ventas|floatformat:2 }}</strong></td>
                            </tr>
                            <tr class="text-danger">
                                <td>Descuentos aplicados:</td>
                                <td class="text-end">- ${{ resumen.total_descuentos|floatformat:2 }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">üè™ Ventas por Canal</h5>
                </div>
                <div class="card-body">
                    {% if ventas_canal %}
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Canal</th>
                                    <th class="text-end">Total</th>
                                    <th class="text-end">Cant.</th>
                                    <th class="text-end">Ticket Prom.</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for canal in ventas_canal %}
                                <tr>
                                    <td>
                                        {% if canal.canal == 'presencial' %}
                                            üè™ Presencial
                                        {% else %}
                                            üöö Delivery
                                        {% endif %}
                                    </td>
                                    <td class="text-end">${{ canal.total|floatformat:0 }}</td>
                                    <td class="text-end">{{ canal.cantidad }}</td>
                                    <td class="text-end">${{ canal.ticket_promedio|floatformat:0 }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <p class="text-muted">No hay datos de ventas por canal</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Top Productos -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">üèÜ Top 10 Productos M√°s Vendidos (30 d√≠as)</h5>
                </div>
                <div class="card-body">
                    {% if productos_top %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>#</th>
                                        <th>Producto</th>
                                        <th>Categor√≠a</th>
                                        <th class="text-end">Cantidad Vendida</th>
                                        <th class="text-end">Ingresos</th>
                                        <th class="text-end">Transacciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for producto in productos_top %}
                                    <tr>
                                        <td>{{ forloop.counter }}</td>
                                        <td><strong>{{ producto.nombre }}</strong></td>
                                        <td><span class="badge bg-secondary">{{ producto.categoria|default:"Sin categor√≠a" }}</span></td>
                                        <td class="text-end">{{ producto.cantidad_vendida }}</td>
                                        <td class="text-end text-success"><strong>${{ producto.ingresos|floatformat:0 }}</strong></td>
                                        <td class="text-end">{{ producto.transacciones }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <strong>‚ÑπÔ∏è Sin datos</strong> - No hay productos vendidos en los √∫ltimos 30 d√≠as.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Ventas por Categor√≠a -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">üì¶ Ventas por Categor√≠a</h5>
                </div>
                <div class="card-body">
                    {% if categorias.labels %}
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Categor√≠a</th>
                                    <th class="text-end">Total Ventas</th>
                                    <th class="text-end">Productos Vendidos</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for label in categorias.labels %}
                                <tr>
                                    <td>{{ label }}</td>
                                    <td class="text-end">${{ categorias.totales|index:forloop.counter0|floatformat:0 }}</td>
                                    <td class="text-end">{{ categorias.cantidades|index:forloop.counter0 }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <p class="text-muted">No hay datos de categor√≠as</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Top Clientes -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">üë• Top 5 Clientes</h5>
                </div>
                <div class="card-body">
                    {% if clientes_top %}
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Cliente</th>
                                    <th class="text-end">Total Compras</th>
                                    <th class="text-end">N¬∞ Compras</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for cliente in clientes_top %}
                                <tr>
                                    <td>
                                        <strong>{{ cliente.nombre }}</strong><br>
                                        <small class="text-muted">{{ cliente.rut }}</small>
                                    </td>
                                    <td class="text-end">${{ cliente.total_compras|floatformat:0 }}</td>
                                    <td class="text-end">{{ cliente.num_compras }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <div class="alert alert-info mb-0">
                            <strong>‚ÑπÔ∏è Sin datos</strong> - No hay clientes registrados con compras.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Gr√°ficos -->
    <div class="row mb-4">
        <!-- Ventas Diarias (L√≠neas) -->
        <div class="col-md-12 mb-4">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">üìà Ventas Diarias (√öltimos 30 D√≠as)</h5>
                </div>
                <div class="card-body">
                    <canvas id="ventasDiariasChart" height="80"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <!-- Ventas por Categor√≠a (Dona) -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">üì¶ Ventas por Categor√≠a</h5>
                </div>
                <div class="card-body">
                    <canvas id="ventasCategoriasChart" height="200"></canvas>
                </div>
            </div>
        </div>

        <!-- Ventas por Canal (Barras) -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">üè™ Ventas por Canal</h5>
                </div>
                <div class="card-body">
                    <canvas id="ventasCanalChart" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <!-- Top Productos (Barras Horizontales) -->
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">üèÜ Top 10 Productos M√°s Vendidos</h5>
                </div>
                <div class="card-body">
                    <canvas id="topProductosChart" height="100"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// Configuraci√≥n de colores
const colors = {
    primary: '#0d6efd',
    success: '#198754',
    danger: '#dc3545',
    warning: '#ffc107',
    info: '#0dcaf0',
    purple: '#6f42c1',
    orange: '#fd7e14',
    teal: '#20c997',
    pink: '#d63384'
};

const chartColors = [
    colors.primary, colors.success, colors.warning, colors.info,
    colors.purple, colors.orange, colors.teal, colors.pink,
    colors.danger, '#6c757d'
];

// 1. Gr√°fico de Ventas Diarias (L√≠neas)
{% if ventas_diarias %}
const ventasDiariasCtx = document.getElementById('ventasDiariasChart').getContext('2d');
new Chart(ventasDiariasCtx, {
    type: 'line',
    data: {
        labels: [{% for dia in ventas_diarias %}'{{ dia.fecha|date:"d/m" }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
        datasets: [{
            label: 'Ventas Diarias',
            data: [{% for dia in ventas_diarias %}{{ dia.total|default:0 }}{% if not forloop.last %}, {% endif %}{% endfor %}],
            borderColor: colors.primary,
            backgroundColor: colors.primary + '20',
            fill: true,
            tension: 0.4
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: { display: false },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return '$' + context.parsed.y.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ".");
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return '$' + value.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ".");
                    }
                }
            }
        }
    }
});
{% endif %}

// 2. Gr√°fico de Ventas por Categor√≠a (Dona)
{% if categorias.labels %}
const ventasCategoriasCtx = document.getElementById('ventasCategoriasChart').getContext('2d');
new Chart(ventasCategoriasCtx, {
    type: 'doughnut',
    data: {
        labels: [{% for label in categorias.labels %}'{{ label }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
        datasets: [{
            data: [{% for total in categorias.totales %}{{ total|default:0 }}{% if not forloop.last %}, {% endif %}{% endfor %}],
            backgroundColor: chartColors
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { position: 'bottom' },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.label + ': $' + context.parsed.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ".");
                    }
                }
            }
        }
    }
});
{% endif %}

// 3. Gr√°fico de Ventas por Canal (Barras)
{% if ventas_canal %}
const ventasCanalCtx = document.getElementById('ventasCanalChart').getContext('2d');
new Chart(ventasCanalCtx, {
    type: 'bar',
    data: {
        labels: [{% for canal in ventas_canal %}'{% if canal.canal == "presencial" %}Presencial{% else %}Delivery{% endif %}'{% if not forloop.last %}, {% endif %}{% endfor %}],
        datasets: [{
            label: 'Total Ventas',
            data: [{% for canal in ventas_canal %}{{ canal.total|default:0 }}{% if not forloop.last %}, {% endif %}{% endfor %}],
            backgroundColor: [colors.success, colors.info]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: false },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return '$' + context.parsed.y.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ".");
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return '$' + value.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ".");
                    }
                }
            }
        }
    }
});
{% endif %}

// 4. Gr√°fico Top Productos (Barras Horizontales)
{% if productos_top %}
const topProductosCtx = document.getElementById('topProductosChart').getContext('2d');
new Chart(topProductosCtx, {
    type: 'bar',
    data: {
        labels: [{% for producto in productos_top %}'{{ producto.nombre|truncatechars:20 }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
        datasets: [{
            label: 'Ingresos',
            data: [{% for producto in productos_top %}{{ producto.ingresos|default:0 }}{% if not forloop.last %}, {% endif %}{% endfor %}],
            backgroundColor: chartColors
        }]
    },
    options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: { display: false },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return '$' + context.parsed.x.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ".");
                    }
                }
            }
        },
        scales: {
            x: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return '$' + value.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ".");
                    }
                }
            }
        }
    }
});
{% endif %}
</script>
{% endblock %}
